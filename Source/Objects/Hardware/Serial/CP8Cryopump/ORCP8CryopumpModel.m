//--------------------------------------------------------
// ORCP8CryopumpModel
// Created by Mark Howe Tuesday, March 20,2012
// Code partially generated by the OrcaCodeWizard. Written by Mark A. Howe.
// Copyright (c) 2012, University of North Carolina. All rights reserved.
//-----------------------------------------------------------
//This program was prepared for the Regents of the University of 
//North Carolina sponsored in part by the United States 
//Department of Energy (DOE) under Grant #DE-FG02-97ER41020. 
//The University has certain rights in the program pursuant to 
//the contract and the program should not be copied or distributed 
//outside your organization.  The DOE and the University of 
//North Carolina reserve all rights in the program. Neither the authors,
//University of North Carolina, or U.S. Government make any warranty, 
//express or implied, or assume any liability or responsibility 
//for the use of this software.
//-------------------------------------------------------------

#pragma mark •••Imported Files

#import "ORCP8CryopumpModel.h"
#import "ORSerialPort.h"
#import "ORSerialPortList.h"
#import "ORSerialPort.h"
#import "ORSerialPortAdditions.h"
#import "ORDataTypeAssigner.h"
#import "ORDataPacket.h"
#import "ORTimeRate.h"

#pragma mark •••External Strings
NSString* ORCP8CryopumpModelStandbyModeChanged				= @"ORCP8CryopumpModelStandbyModeChanged";
NSString* ORCP8CryopumpModelRepurgeTimeChanged				= @"ORCP8CryopumpModelRepurgeTimeChanged";
NSString* ORCP8CryopumpModelPumpsPerCompressorChanged		= @"ORCP8CryopumpModelPumpsPerCompressorChanged";
NSString* ORCP8CryopumpModelRoughingInterlockChanged		= @"ORCP8CryopumpModelRoughingInterlockChanged";
NSString* ORCP8CryopumpModelRestartTemperatureChanged		= @"ORCP8CryopumpModelRestartTemperatureChanged";
NSString* ORCP8CryopumpModelRateOfRiseCyclesChanged			= @"ORCP8CryopumpModelRateOfRiseCyclesChanged";
NSString* ORCP8CryopumpModelRateOfRiseChanged				= @"ORCP8CryopumpModelRateOfRiseChanged";
NSString* ORCP8CryopumpModelRoughToPressureChanged			= @"ORCP8CryopumpModelRoughToPressureChanged";
NSString* ORCP8CryopumpModelRepurgeCyclesChanged			= @"ORCP8CryopumpModelRepurgeCyclesChanged";
NSString* ORCP8CryopumpModelExtendedPurgeTimeChanged		= @"ORCP8CryopumpModelExtendedPurgeTimeChanged";
NSString* ORCP8CryopumpModelPumpRestartDelayChanged			= @"ORCP8CryopumpModelPumpRestartDelayChanged";
NSString* ORCP8CryopumpModelThermocouplePressureChanged		= @"ORCP8CryopumpModelThermocouplePressureChanged";
NSString* ORCP8CryopumpModelThermocoupleStatusChanged		= @"ORCP8CryopumpModelThermocoupleStatusChanged";
NSString* ORCP8CryopumpModelStatusChanged					= @"ORCP8CryopumpModelStatusChanged";
NSString* ORCP8CryopumpModelSecondStageTempChanged			= @"ORCP8CryopumpModelSecondStageTempChanged";
NSString* ORCP8CryopumpModelRoughValveInterlockChanged		= @"ORCP8CryopumpModelRoughValveInterlockChanged";
NSString* ORCP8CryopumpModelRoughValveStatusChanged			= @"ORCP8CryopumpModelRoughValveStatusChanged";
NSString* ORCP8CryopumpModelRegenerationTimeChanged			= @"ORCP8CryopumpModelRegenerationTimeChanged";
NSString* ORCP8CryopumpModelRegenerationStepTimerChanged	= @"ORCP8CryopumpModelRegenerationStepTimerChanged";
NSString* ORCP8CryopumpModelRegenerationStartDelayChanged	= @"ORCP8CryopumpModelRegenerationStartDelayChanged";
NSString* ORCP8CryopumpModelRegenerationSequenceChanged		= @"ORCP8CryopumpModelRegenerationSequenceChanged";
NSString* ORCP8CryopumpModelRegenerationTypeChanged			= @"ORCP8CryopumpModelRegenerationTypeChanged";
NSString* ORCP8CryopumpModelRegenerationParameterChanged	= @"ORCP8CryopumpModelRegenerationParameterChanged";
NSString* ORCP8CryopumpModelRegenerationErrorChanged		= @"ORCP8CryopumpModelRegenerationErrorChanged";
NSString* ORCP8CryopumpModelRegenerationCyclesChanged		= @"ORCP8CryopumpModelRegenerationCyclesChanged";
NSString* ORCP8CryopumpModelRegenerationChanged				= @"ORCP8CryopumpModelRegenerationChanged";
NSString* ORCP8CryopumpModelPurgeStatusChanged				= @"ORCP8CryopumpModelPurgeStatusChanged";
NSString* ORCP8CryopumpModelPumpQueryChanged				= @"ORCP8CryopumpModelPumpQueryChanged";
NSString* ORCP8CryopumpModelPumpStatusChanged				= @"ORCP8CryopumpModelPumpStatusChanged";
NSString* ORCP8CryopumpModelPowerFailureRecoveryStatusChanged = @"ORCP8CryopumpModelPowerFailureRecoveryStatusChanged";
NSString* ORCP8CryopumpModelPowerFailureRecoveryChanged		= @"ORCP8CryopumpModelPowerFailureRecoveryChanged";
NSString* ORCP8CryopumpModelModuleVersionChanged			= @"ORCP8CryopumpModelModuleVersionChanged";
NSString* ORCP8CryopumpModelLastRateOfRaiseChanged			= @"ORCP8CryopumpModelLastRateOfRaiseChanged";
NSString* ORCP8CryopumpModelFirstStageControlMethodChanged	= @"ORCP8CryopumpModelFirstStageControlMethodChanged";
NSString* ORCP8CryopumpModelFirstStageControlTempChanged	= @"ORCP8CryopumpModelFirstStageControlTempChanged";
NSString* ORCP8CryopumpModelFirstStageTempChanged			= @"ORCP8CryopumpModelFirstStageTempChanged";
NSString* ORCP8CryopumpModelFailedRepurgeCyclesChanged		= @"ORCP8CryopumpModelFailedRepurgeCyclesChanged";
NSString* ORCP8CryopumpModelFailedRateRiseCyclesChanged		= @"ORCP8CryopumpModelFailedRateRiseCyclesChanged";
NSString* ORCP8CryopumpModelElapsedTimeChanged				= @"ORCP8CryopumpModelElapsedTimeChanged";
NSString* ORCP8CryopumpModelDutyCycleChanged				= @"ORCP8CryopumpModelDutyCycleChanged";
NSString* ORCP8CryopumpShipTemperaturesChanged				= @"ORCP8CryopumpShipTemperaturesChanged";
NSString* ORCP8CryopumpPollTimeChanged						= @"ORCP8CryopumpPollTimeChanged";
NSString* ORCP8CryopumpSerialPortChanged					= @"ORCP8CryopumpSerialPortChanged";
NSString* ORCP8CryopumpPortNameChanged						= @"ORCP8CryopumpPortNameChanged";
NSString* ORCP8CryopumpPortStateChanged						= @"ORCP8CryopumpPortStateChanged";
NSString* ORCP8CryopumpTemperatureChanged					= @"ORCP8CryopumpTemperatureChanged";
NSString* ORCP8CryopumpLock									= @"ORCP8CryopumpLock";

@interface ORCP8CryopumpModel (private)
- (void) runStarted:(NSNotification*)aNote;
- (void) runStopped:(NSNotification*)aNote;
- (void) timeout;
- (void) processOneCommandFromQueue;
- (void) process_response:(NSString*)theResponse;
- (NSString*) checkSum:(NSString*)aCmd;
@end

@implementation ORCP8CryopumpModel
- (id) init
{
	self = [super init];
    [self registerNotificationObservers];
	return self;
}


- (void) dealloc
{
    [[NSNotificationCenter defaultCenter] removeObserver:self];
    [NSObject cancelPreviousPerformRequestsWithTarget:self];
    [buffer release];
	[cmdQueue release];
	[lastRequest release];
    [portName release];
    if([serialPort isOpen]){
        [serialPort close];
    }
    [serialPort release];
	[timeRates release];
    [moduleVersion release];

	[super dealloc];
}

- (void) setUpImage
{
	[self setImage:[NSImage imageNamed:@"CP8Cryopump.tif"]];
}

- (void) makeMainController
{
	[self linkToController:@"ORCP8CryopumpController"];
}

- (NSString*) helpURL
{
	return @"RS232/MKS_651c.html";
}

- (void) registerNotificationObservers
{
	NSNotificationCenter* notifyCenter = [NSNotificationCenter defaultCenter];

    [notifyCenter addObserver : self
                     selector : @selector(dataReceived:)
                         name : ORSerialPortDataReceived
                       object : nil];

    [notifyCenter addObserver: self
                     selector: @selector(runStarted:)
                         name: ORRunStartedNotification
                       object: nil];
    
    [notifyCenter addObserver: self
                     selector: @selector(runStopped:)
                         name: ORRunStoppedNotification
                       object: nil];
}

- (void) dataReceived:(NSNotification*)note
{
    if([[note userInfo] objectForKey:@"serialPort"] == serialPort){
		[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(timeout) object:nil];
        NSString* theString = [[[[NSString alloc] initWithData:[[note userInfo] objectForKey:@"data"] 
												      encoding:NSASCIIStringEncoding] autorelease] uppercaseString];

		//the serial port may break the data up into small chunks, so we have to accumulate the chunks until
		//we get a full piece.
        if(!buffer)buffer = [[NSMutableString string] retain];
        [buffer appendString:theString];					
		
        do {
            NSRange lineRange = [buffer rangeOfString:@"\r"];
            if(lineRange.location!= NSNotFound){
                NSMutableString* theResponse = [[[buffer substringToIndex:lineRange.location+1] mutableCopy] autorelease];
                [buffer deleteCharactersInRange:NSMakeRange(0,lineRange.location+1)];      //take the cmd out of the buffer
				
				[self process_response:theResponse];
    
				[self setLastRequest:nil];			 //clear the last request
				[self processOneCommandFromQueue];	 //do the next command in the queue
            }
        } while([buffer rangeOfString:@"\r\n"].location!= NSNotFound);
	}
}

- (void) shipTemperatureValues
{
    if([[ORGlobal sharedGlobal] runInProgress]){
		
		unsigned long data[6];
		data[0] = dataId | 6;
		data[1] = ([self uniqueIdNumber]&0xfff);
		
		union {
			float asFloat;
			unsigned long asLong;
		}theData;
		
		int index = 2;
			theData.asFloat = temperature;
			data[index] = theData.asLong;
			index++;
			
			data[index] = timeMeasured;
			index++;
		[[NSNotificationCenter defaultCenter] postNotificationName:ORQueueRecordForShippingNotification 
															object:[NSData dataWithBytes:data length:sizeof(long)*6]];
	}
}

#pragma mark •••Accessors

- (BOOL) standbyMode
{
    return standbyMode;
}

- (void) setStandbyMode:(BOOL)aStandbyMode
{
    [[[self undoManager] prepareWithInvocationTarget:self] setStandbyMode:standbyMode];
    standbyMode = aStandbyMode;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelStandbyModeChanged object:self];
}

- (int) repurgeTime
{
    return repurgeTime;
}

- (void) setRepurgeTime:(int)aRepurgeTime
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRepurgeTime:repurgeTime];
    repurgeTime = aRepurgeTime;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRepurgeTimeChanged object:self];
}

- (int) pumpsPerCompressor
{
    return pumpsPerCompressor;
}

- (void) setPumpsPerCompressor:(int)aPumpsPerCompressor
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPumpsPerCompressor:pumpsPerCompressor];
    pumpsPerCompressor = aPumpsPerCompressor;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPumpsPerCompressorChanged object:self];
}

- (BOOL) roughingInterlock
{
    return roughingInterlock;
}

- (void) setRoughingInterlock:(BOOL)aRoughingInterlock
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRoughingInterlock:roughingInterlock];
    roughingInterlock = aRoughingInterlock;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRoughingInterlockChanged object:self];
}

- (int) restartTemperature
{
    return restartTemperature;
}

- (void) setRestartTemperature:(int)aRestartTemperature
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRestartTemperature:restartTemperature];
    restartTemperature = aRestartTemperature;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRestartTemperatureChanged object:self];
}

- (int) rateOfRiseCycles
{
    return rateOfRiseCycles;
}

- (void) setRateOfRiseCycles:(int)aRateOfRiseCycles
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRateOfRiseCycles:rateOfRiseCycles];
    rateOfRiseCycles = aRateOfRiseCycles;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRateOfRiseCyclesChanged object:self];
}

- (int) rateOfRise
{
    return rateOfRise;
}

- (void) setRateOfRise:(int)aRateOfRise
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRateOfRise:rateOfRise];
    rateOfRise = aRateOfRise;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRateOfRiseChanged object:self];
}

- (int) roughToPressure
{
    return roughToPressure;
}

- (void) setRoughToPressure:(int)aRoughToPressure
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRoughToPressure:roughToPressure];
    roughToPressure = aRoughToPressure;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRoughToPressureChanged object:self];
}

- (int) repurgeCycles
{
    return repurgeCycles;
}

- (void) setRepurgeCycles:(int)aRepurgeCycles
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRepurgeCycles:repurgeCycles];
    repurgeCycles = aRepurgeCycles;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRepurgeCyclesChanged object:self];
}

- (int) extendedPurgeTime
{
    return extendedPurgeTime;
}

- (void) setExtendedPurgeTime:(int)aExtendedPurgeTime
{
    [[[self undoManager] prepareWithInvocationTarget:self] setExtendedPurgeTime:extendedPurgeTime];
    extendedPurgeTime = aExtendedPurgeTime;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelExtendedPurgeTimeChanged object:self];
}

- (int) pumpRestartDelay
{
    return pumpRestartDelay;
}

- (void) setPumpRestartDelay:(int)aPumpRestartDelay
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPumpRestartDelay:pumpRestartDelay];
    pumpRestartDelay = aPumpRestartDelay;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPumpRestartDelayChanged object:self];
}

- (float) thermocouplePressure
{
    return thermocouplePressure;
}

- (void) setThermocouplePressure:(float)aThermocouplePressure
{
    thermocouplePressure = aThermocouplePressure;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelThermocouplePressureChanged object:self];
}

- (int) thermocoupleStatus
{
    return thermocoupleStatus;
}

- (void) setThermocoupleStatus:(int)aThermocoupleStatus
{
    thermocoupleStatus = aThermocoupleStatus;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelThermocoupleStatusChanged object:self];
}

- (int) status
{
    return status;
}

- (void) setStatus:(int)aStatus
{
    status = aStatus;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelStatusChanged object:self];
}

- (float) secondStageTemp
{
    return secondStageTemp;
}

- (void) setSecondStageTemp:(float)aSecondStageTemp
{
    secondStageTemp = aSecondStageTemp;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelSecondStageTempChanged object:self];
}

- (int) roughValveInterlock
{
    return roughValveInterlock;
}

- (void) setRoughValveInterlock:(int)aRoughValveInterlock
{
    roughValveInterlock = aRoughValveInterlock;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRoughValveInterlockChanged object:self];
}

- (int) roughValveStatus
{
    return roughValveStatus;
}

- (void) setRoughValveStatus:(int)aRoughValveStatus
{
    roughValveStatus = aRoughValveStatus;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRoughValveStatusChanged object:self];
}

- (int) regenerationTime
{
    return regenerationTime;
}

- (void) setRegenerationTime:(int)aRegenerationTime
{
    regenerationTime = aRegenerationTime;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationTimeChanged object:self];
}

- (int) regenerationStepTimer
{
    return regenerationStepTimer;
}

- (void) setRegenerationStepTimer:(int)aRegenerationStepTimer
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRegenerationStepTimer:regenerationStepTimer];
    regenerationStepTimer = aRegenerationStepTimer;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationStepTimerChanged object:self];
}

- (int) regenerationStartDelay
{
    return regenerationStartDelay;
}

- (void) setRegenerationStartDelay:(int)aRegenerationStartDelay
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRegenerationStartDelay:regenerationStartDelay];
    regenerationStartDelay = aRegenerationStartDelay;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationStartDelayChanged object:self];
}

- (int) regenerationSequence
{
    return regenerationSequence;
}

- (void) setRegenerationSequence:(int)aRegenerationSequence
{
    regenerationSequence = aRegenerationSequence;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationSequenceChanged object:self];
}

- (int) regenerationType
{
    return regenerationType;
}

- (void) setRegenerationType:(int)aRegenerationType
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRegenerationType:regenerationType];
    regenerationType = aRegenerationType;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationTypeChanged object:self];
}

- (int) regenerationParameter
{
    return regenerationParameter;
}

- (void) setRegenerationParameter:(int)aRegenerationParameter
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRegenerationParameter:regenerationParameter];
    regenerationParameter = aRegenerationParameter;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationParameterChanged object:self];
}

- (int) regenerationError
{
    return regenerationError;
}

- (void) setRegenerationError:(int)aRegenerationError
{
    regenerationError = aRegenerationError;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationErrorChanged object:self];
}

- (int) regenerationCycles
{
    return regenerationCycles;
}

- (void) setRegenerationCycles:(int)aRegenerationCycles
{
    regenerationCycles = aRegenerationCycles;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationCyclesChanged object:self];
}

- (int) regeneration
{
    return regeneration;
}

- (void) setRegeneration:(int)aRegeneration
{
    [[[self undoManager] prepareWithInvocationTarget:self] setRegeneration:regeneration];
    regeneration = aRegeneration;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelRegenerationChanged object:self];
}

- (int) purgeStatus
{
    return purgeStatus;
}

- (void) setPurgeStatus:(int)aPurgeStatus
{
    purgeStatus = aPurgeStatus;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPurgeStatusChanged object:self];
}

- (int) pumpQuery
{
    return pumpQuery;
}

- (void) setPumpQuery:(int)aPumpQuery
{
    pumpQuery = aPumpQuery;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPumpQueryChanged object:self];
}

- (int) pumpStatus
{
    return pumpStatus;
}

- (void) setPumpStatus:(int)aPumpStatus
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPumpStatus:pumpStatus];
    pumpStatus = aPumpStatus;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPumpStatusChanged object:self];
}

- (int) powerFailureRecoveryStatus
{
    return powerFailureRecoveryStatus;
}

- (void) setPowerFailureRecoveryStatus:(int)aPowerFailureRecoveryStatus
{
    powerFailureRecoveryStatus = aPowerFailureRecoveryStatus;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPowerFailureRecoveryStatusChanged object:self];
}

- (int) powerFailureRecovery
{
    return powerFailureRecovery;
}

- (void) setPowerFailureRecovery:(int)aPowerFailureRecovery
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPowerFailureRecovery:powerFailureRecovery];
    powerFailureRecovery = aPowerFailureRecovery;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelPowerFailureRecoveryChanged object:self];
}

- (NSString*) moduleVersion
{
    return moduleVersion;
}

- (void) setModuleVersion:(NSString*)aModuleVersion
{
    [moduleVersion autorelease];
    moduleVersion = [aModuleVersion copy];    

    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelModuleVersionChanged object:self];
}

- (int) lastRateOfRaise
{
    return lastRateOfRaise;
}

- (void) setLastRateOfRaise:(int)aLastRateOfRaise
{
    lastRateOfRaise = aLastRateOfRaise;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelLastRateOfRaiseChanged object:self];
}

- (int) firstStageControlMethod
{
    return firstStageControlMethod;
}

- (void) setFirstStageControlMethod:(int)aFirstStageControlMethod
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFirstStageControlMethod:firstStageControlMethod];
    firstStageControlMethod = aFirstStageControlMethod;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelFirstStageControlMethodChanged object:self];
}

- (int) firstStageControlTemp
{
    return firstStageControlTemp;
}

- (void) setFirstStageControlTemp:(int)aFirstStageControlTemp
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFirstStageControlTemp:firstStageControlTemp];
    firstStageControlTemp = aFirstStageControlTemp;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelFirstStageControlTempChanged object:self];
}

- (float) firstStageTemp
{
    return firstStageTemp;
}

- (void) setFirstStageTemp:(float)aFirstStageTemp
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFirstStageTemp:firstStageTemp];
    firstStageTemp = aFirstStageTemp;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelFirstStageTempChanged object:self];
}

- (int) failedRepurgeCycles
{
    return failedRepurgeCycles;
}

- (void) setFailedRepurgeCycles:(int)aFailedRepurgeCycles
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFailedRepurgeCycles:failedRepurgeCycles];
    failedRepurgeCycles = aFailedRepurgeCycles;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelFailedRepurgeCyclesChanged object:self];
}

- (int) failedRateRiseCycles
{
    return failedRateRiseCycles;
}

- (void) setFailedRateRiseCycles:(int)aFailedRateRiseCycles
{
    [[[self undoManager] prepareWithInvocationTarget:self] setFailedRateRiseCycles:failedRateRiseCycles];
    failedRateRiseCycles = aFailedRateRiseCycles;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelFailedRateRiseCyclesChanged object:self];
}

- (int) elapsedTime
{
    return elapsedTime;
}

- (void) setElapsedTime:(int)aElapsedTime
{
    [[[self undoManager] prepareWithInvocationTarget:self] setElapsedTime:elapsedTime];
    
    elapsedTime = aElapsedTime;

    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelElapsedTimeChanged object:self];
}

- (int) dutyCycle
{
    return dutyCycle;
}

- (void) setDutyCycle:(int)aDutyCycle
{
    [[[self undoManager] prepareWithInvocationTarget:self] setDutyCycle:dutyCycle];
    dutyCycle = aDutyCycle;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpModelDutyCycleChanged object:self];
}

- (ORTimeRate*)timeRate
{
	return timeRates;
}

- (BOOL) shipTemperatures
{
    return shipTemperatures;
}

- (void) setShipTemperatures:(BOOL)aState
{
    [[[self undoManager] prepareWithInvocationTarget:self] setShipTemperatures:shipTemperatures];
    shipTemperatures = aState;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpShipTemperaturesChanged object:self];
}

- (int) pollTime
{
    return pollTime;
}

- (void) setPollTime:(int)aPollTime
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPollTime:pollTime];
    pollTime = aPollTime;
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpPollTimeChanged object:self];

	if(pollTime){
		[self performSelector:@selector(pollHardware) withObject:nil afterDelay:2];
	}
	else {
		[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(pollHardware) object:nil];
	}
}

- (float) temperature
{
	return temperature;
}

- (unsigned long) timeMeasured
{
	return timeMeasured;
}

- (void) setTemperature:(float)aValue
{
	temperature = aValue;
	//get the time(UT!)
	time_t	ut_Time;
	time(&ut_Time);
	//struct tm* theTimeGMTAsStruct = gmtime(&theTime);
	timeMeasured = ut_Time;


	if(timeRates == nil) timeRates = [[ORTimeRate alloc] init];
	[timeRates addDataToTimeAverage:aValue];
	
	[[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpTemperatureChanged 
														object:self];
}

- (NSString*) lastRequest
{
	return lastRequest;
}

- (void) setLastRequest:(NSString*)aRequest
{
	[lastRequest autorelease];
	lastRequest = [aRequest copy];    
}

- (BOOL) portWasOpen
{
    return portWasOpen;
}

- (void) setPortWasOpen:(BOOL)aPortWasOpen
{
    portWasOpen = aPortWasOpen;
}

- (NSString*) portName
{
    return portName;
}

- (void) setPortName:(NSString*)aPortName
{
    [[[self undoManager] prepareWithInvocationTarget:self] setPortName:portName];
    
    if(![aPortName isEqualToString:portName]){
        [portName autorelease];
        portName = [aPortName copy];    

        BOOL valid = NO;
        NSEnumerator *enumerator = [ORSerialPortList portEnumerator];
        ORSerialPort *aPort;
        while (aPort = [enumerator nextObject]) {
            if([portName isEqualToString:[aPort name]]){
                [self setSerialPort:aPort];
                if(portWasOpen){
                    [self openPort:YES];
                 }
                valid = YES;
                break;
            }
        } 
        if(!valid){
            [self setSerialPort:nil];
        }       
    }

    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpPortNameChanged object:self];
}

- (ORSerialPort*) serialPort
{
    return serialPort;
}

- (void) setSerialPort:(ORSerialPort*)aSerialPort
{
    [aSerialPort retain];
    [serialPort release];
    serialPort = aSerialPort;

    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpSerialPortChanged object:self];
}

- (void) openPort:(BOOL)state
{
    if(state) {
        [serialPort open];
		[serialPort setSpeed:2400];
		[serialPort setParityEven];
		[serialPort setStopBits2:0];
		[serialPort setDataBits:7];
		[serialPort commitChanges];
    }
    else      [serialPort close];
    portWasOpen = [serialPort isOpen];
    [[NSNotificationCenter defaultCenter] postNotificationName:ORCP8CryopumpPortStateChanged object:self];
}


#pragma mark •••Archival
- (id) initWithCoder:(NSCoder*)decoder
{
	self = [super initWithCoder:decoder];
	[[self undoManager] disableUndoRegistration];
	[self setStandbyMode:				[decoder decodeBoolForKey:@"standbyMode"]];
	[self setRepurgeTime:				[decoder decodeIntForKey:@"repurgeTime"]];
	[self setPumpsPerCompressor:		[decoder decodeIntForKey:@"pumpsPerCompressor"]];
	[self setPumpsPerCompressor:		[decoder decodeIntForKey:@"pumpsPerCompressor"]];
	[self setRoughingInterlock:			[decoder decodeBoolForKey:@"roughingInterlock"]];
	[self setRestartTemperature:		[decoder decodeIntForKey:@"restartTemperature"]];
	[self setRateOfRiseCycles:			[decoder decodeIntForKey:@"rateOfRiseCycles"]];
	[self setRateOfRise:				[decoder decodeIntForKey:@"rateOfRise"]];
	[self setRoughToPressure:			[decoder decodeIntForKey:@"roughToPressure"]];
	[self setRepurgeCycles:				[decoder decodeIntForKey:@"repurgeCycles"]];
	[self setExtendedPurgeTime:			[decoder decodeIntForKey:@"extendedPurgeTime"]];
	[self setPumpRestartDelay:			[decoder decodeIntForKey:@"pumpRestartDelay"]];
	[self setRegenerationStepTimer:		[decoder decodeIntForKey:@"regenerationStepTimer"]];
	[self setRegenerationStartDelay:	[decoder decodeIntForKey:@"regenerationStartDelay"]];
	[self setRegenerationType:			[decoder decodeIntForKey:@"regenerationType"]];
	[self setRegenerationParameter:		[decoder decodeIntForKey:@"regenerationParameter"]];
	[self setRegeneration:				[decoder decodeIntForKey:@"regeneration"]];
	[self setPumpStatus:				[decoder decodeIntForKey:@"pumpStatus"]];
	[self setPowerFailureRecovery:		[decoder decodeIntForKey:@"powerFailureRecovery"]];
	[self setLastRateOfRaise:			[decoder decodeIntForKey:@"lastRateOfRaise"]];
	[self setFirstStageControlMethod:	[decoder decodeIntForKey:@"firstStageControlMethod"]];
	[self setFirstStageControlTemp:		[decoder decodeIntForKey:@"firstStageControlTemp"]];
	[self setFirstStageTemp:			[decoder decodeFloatForKey:@"firstStageTemp"]];
	[self setElapsedTime:				[decoder decodeIntForKey:@"elapsedTime"]];
	[self setDutyCycle:					[decoder decodeIntForKey:@"dutyCycle"]];
	[self setShipTemperatures:			[decoder decodeBoolForKey:	 @"shipTemperatures"]];
	[self setPollTime:					[decoder decodeIntForKey:	 @"pollTime"]];
	[self setPortWasOpen:				[decoder decodeBoolForKey:	 @"portWasOpen"]];
    [self setPortName:					[decoder decodeObjectForKey: @"portName"]];
	
	[[self undoManager] enableUndoRegistration];
	timeRates = [[ORTimeRate alloc] init];
    [self registerNotificationObservers];

	return self;
}

- (void) encodeWithCoder:(NSCoder*)encoder
{
    [super encodeWithCoder:encoder];
    [encoder encodeBool:standbyMode				forKey:@"standbyMode"];
    [encoder encodeInt:repurgeTime				forKey:@"repurgeTime"];
    [encoder encodeInt:pumpsPerCompressor		forKey:@"pumpsPerCompressor"];
    [encoder encodeInt:pumpsPerCompressor		forKey:@"pumpsPerCompressor"];
    [encoder encodeBool:roughingInterlock		forKey:@"roughingInterlock"];
    [encoder encodeInt:restartTemperature		forKey:@"restartTemperature"];
    [encoder encodeInt:rateOfRiseCycles			forKey:@"rateOfRiseCycles"];
    [encoder encodeInt:rateOfRise				forKey:@"rateOfRise"];
    [encoder encodeInt:roughToPressure			forKey:@"roughToPressure"];
    [encoder encodeInt:repurgeCycles			forKey:@"repurgeCycles"];
    [encoder encodeInt:extendedPurgeTime		forKey:@"extendedPurgeTime"];
    [encoder encodeInt:pumpRestartDelay			forKey:@"pumpRestartDelay"];
    [encoder encodeInt:regenerationStepTimer	forKey: @"regenerationStepTimer"];
    [encoder encodeInt:regenerationStartDelay	forKey: @"regenerationStartDelay"];
    [encoder encodeInt:regenerationType			forKey: @"regenerationType"];
    [encoder encodeInt:regenerationParameter	forKey: @"regenerationParameter"];
    [encoder encodeInt:regeneration				forKey: @"regeneration"];
    [encoder encodeInt:pumpStatus				forKey: @"pumpStatus"];
    [encoder encodeInt:powerFailureRecovery		forKey: @"powerFailureRecovery"];
    [encoder encodeInt:firstStageControlMethod	forKey:@"firstStageControlMethod"];
    [encoder encodeInt:firstStageControlTemp	forKey:@"firstStageControlTemp"];
    [encoder encodeFloat:firstStageTemp			forKey:@"firstStageTemp"];
    [encoder encodeInt:elapsedTime				forKey:@"elapsedTime"];
    [encoder encodeInt:dutyCycle				forKey:@"dutyCycle"];
    [encoder encodeBool:shipTemperatures		forKey: @"shipTemperatures"];
    [encoder encodeInt: pollTime				forKey: @"pollTime"];
    [encoder encodeBool:portWasOpen				forKey: @"portWasOpen"];
    [encoder encodeObject:portName				forKey: @"portName"];
}

#pragma mark ••• Commands
- (void) addCmdToQueue:(NSString*)aCmd waitForResponse:(BOOL)waitForResponse
{
    //if([serialPort isOpen]){ 
		if(![aCmd hasPrefix:@"++"]){
			//make sure the someone didn't add stuff that we are going to add.
			aCmd = [aCmd stringByReplacingOccurrencesOfString:@"\n" withString:@""];
			aCmd = [aCmd stringByReplacingOccurrencesOfString:@"\r" withString:@""];
			aCmd = [aCmd stringByReplacingOccurrencesOfString:@"$" withString:@""];
		}
		if(!cmdQueue)cmdQueue	 = [[NSMutableArray array] retain];
		ORCP8CryopumpCmd* cmdObj = [[ORCP8CryopumpCmd alloc] init];
		cmdObj.cmd = [NSString stringWithFormat:@"$%@%@\r",aCmd,[self checkSum:aCmd]];
		cmdObj.waitForResponse = waitForResponse;
		
		[cmdQueue addObject:cmdObj];
		if(!lastRequest){
			[self processOneCommandFromQueue];
		}
	//}
}

- (void) readTemperatures
{
	[self readFirstStageTemp];
	[self readSecondStageTemp];
	[self addCmdToQueue:@"++ShipRecords" waitForResponse:NO];
}

- (void) initHardware
{

}

#pragma mark •••Queries
- (void) readDutyCycle					{ [self addCmdToQueue: @"XOI??"	waitForResponse:YES]; }
- (void) readElapsedTime				{ [self addCmdToQueue: @"Y?"	waitForResponse:YES]; }
- (void) readFailedRateRiseCycles		{ [self addCmdToQueue: @"m"		waitForResponse:YES]; }
- (void) readFailedPurgeCycles			{ [self addCmdToQueue: @"I"		waitForResponse:YES]; }
- (void) readFirstStageTemp				{ [self addCmdToQueue: @"J"		waitForResponse:YES]; }
- (void) readFirstStageControlTemp		{ [self addCmdToQueue: @"H?"	waitForResponse:YES]; }
- (void) readLastRateOfRaise			{ [self addCmdToQueue: @"n"		waitForResponse:YES]; } 
- (void) readModuleVersion				{ [self addCmdToQueue: @"@"		waitForResponse:YES]; } 
- (void) readPowerFailureRecoveryStatus	{ [self addCmdToQueue: @"t?"	waitForResponse:YES]; }  
- (void) readPumpStatus					{ [self addCmdToQueue: @"A?"	waitForResponse:YES]; }
- (void) readPurgeStatus				{ [self addCmdToQueue: @"E?"	waitForResponse:YES]; }
- (void) readRegenerationCycles			{ [self addCmdToQueue: @"Z?"	waitForResponse:YES]; }
- (void) readRegenerationError			{ [self addCmdToQueue: @"e"		waitForResponse:YES]; }

- (void) readRegenerationParameters
{
	[self addCmdToQueue:@"P0?" waitForResponse:YES];
	[self addCmdToQueue:@"P1?" waitForResponse:YES];
	[self addCmdToQueue:@"P2?" waitForResponse:YES];
	[self addCmdToQueue:@"P3?" waitForResponse:YES];
	[self addCmdToQueue:@"P4?" waitForResponse:YES];
	[self addCmdToQueue:@"P5?" waitForResponse:YES];
	[self addCmdToQueue:@"P6?" waitForResponse:YES];
	[self addCmdToQueue:@"PA?" waitForResponse:YES];
	[self addCmdToQueue:@"PC?" waitForResponse:YES];
	[self addCmdToQueue:@"PG?" waitForResponse:YES];
	[self addCmdToQueue:@"PS?" waitForResponse:YES];
	[self addCmdToQueue:@"Pz?" waitForResponse:YES];
	
}
- (void) readRegenerationSequence		{ [self addCmdToQueue: @"O"		waitForResponse:YES]; }
- (void) readRegenerationStartDelay		{ [self addCmdToQueue: @"j?"	waitForResponse:YES]; }
- (void) readRegenerationStepTimer		{ [self addCmdToQueue: @"k"		waitForResponse:YES]; }
- (void) readRoughValveStatus			{ [self addCmdToQueue: @"D?"	waitForResponse:YES]; }
- (void) readRoughValveInterlock		{ [self addCmdToQueue: @"Q?"	waitForResponse:YES]; }
- (void) readSecondStageTemp			{ [self addCmdToQueue: @"K"		waitForResponse:YES]; }
- (void) readSecondStageTempControl		{ [self addCmdToQueue: @"I?"	waitForResponse:YES]; }
- (void) readStatus						{ [self addCmdToQueue: @"S1"	waitForResponse:YES]; }
- (void) readThermocoupleStatus			{ [self addCmdToQueue: @"B?"	waitForResponse:YES]; }
- (void) readThermocouplePressure		{ [self addCmdToQueue: @"L"		waitForResponse:YES]; }

#pragma mark •••HW Writes
- (void) writeFirstStageTempControl
{
	[self addCmdToQueue: [NSString stringWithFormat:@"H%d,%d",firstStageControlTemp, firstStageControlMethod]	waitForResponse:YES];
}

- (void) writePowerFailureRecoveryMode
{
	[self addCmdToQueue: [NSString stringWithFormat:@"i%d",powerFailureRecovery]	waitForResponse:YES];
}

- (void) writePumpOnOff
{
	[self addCmdToQueue: [NSString stringWithFormat:@"A%d",pumpStatus]	waitForResponse:YES];
}

- (void) writePurgeOnOff
{
	[self addCmdToQueue: [NSString stringWithFormat:@"E%d",purgeStatus]	waitForResponse:YES];
}

- (void) writeRegenerationCycleParameters
{
	[self addCmdToQueue: [NSString stringWithFormat:@"P0%d",pumpRestartDelay]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"P1%d",extendedPurgeTime]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"P2%d",repurgeCycles]		waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"P3%d",roughToPressure]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"P4%d",rateOfRise]			waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"P5%d",rateOfRiseCycles]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"P6%d",restartTemperature]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"PA%d",roughingInterlock]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"PC%d",pumpsPerCompressor]	waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"PG%d",repurgeTime]		waitForResponse:YES];
	[self addCmdToQueue: [NSString stringWithFormat:@"Pz%d",standbyMode]		waitForResponse:YES];
}

- (void) writeRegenerationStartDelay:(int)aDelay
{
	[self addCmdToQueue: [NSString stringWithFormat:@"j%d",aDelay] waitForResponse:YES];
}

- (void) writeRoughValve:(BOOL)aState
{
	[self addCmdToQueue: [NSString stringWithFormat:@"D%d",aState] waitForResponse:YES];
}

- (void) writeRoughValveInterlockPermissionYes
{
	[self addCmdToQueue: @"Q" waitForResponse:YES];
}

- (void) writeSecondStageControlTemp:(int)aTemp
{
	[self addCmdToQueue: [NSString stringWithFormat:@"I%d",aTemp]	waitForResponse:YES];
}

- (void) writeThermocoupleOnOff:(BOOL)aState
{
	[self addCmdToQueue: [NSString stringWithFormat:@"B%d",aState]	waitForResponse:YES];
}

#pragma mark •••Data Records
- (unsigned long) dataId { return dataId; }
- (void) setDataId: (unsigned long) DataId
{
    dataId = DataId;
}
	 
- (void) setDataIds:(id)assigner
{
    dataId       = [assigner assignDataIds:kLongForm];
}

- (void) syncDataIdsWith:(id)anotherCP8Cryopump
{
    [self setDataId:[anotherCP8Cryopump dataId]];
}

- (void) appendDataDescription:(ORDataPacket*)aDataPacket userInfo:(id)userInfo
{
    //----------------------------------------------------------------------------------------
    // first add our description to the data description
    [aDataPacket addDataDescriptionItem:[self dataRecordDescription] forKey:@"CP8CryopumpModel"];
}

- (NSDictionary*) dataRecordDescription
{
    NSMutableDictionary* dataDictionary = [NSMutableDictionary dictionary];
    NSDictionary* aDictionary = [NSDictionary dictionaryWithObjectsAndKeys:
        @"ORCP8CryopumpDecoderForTemperatures",     @"decoder",
        [NSNumber numberWithLong:dataId],			@"dataId",
        [NSNumber numberWithBool:NO],				@"variable",
        [NSNumber numberWithLong:8],				@"length",
        nil];
    [dataDictionary setObject:aDictionary forKey:@"Temperatures"];
    
    return dataDictionary;
}

- (void) pollHardware
{
	[NSObject cancelPreviousPerformRequestsWithTarget:self selector:@selector(pollHardware) object:nil];
	
	[self readTemperatures];
		
	if(pollTime!=0){
		[self performSelector:@selector(pollHardware) withObject:nil afterDelay:pollTime];
	}
}

@end

@implementation ORCP8CryopumpModel (private)
- (void) runStarted:(NSNotification*)aNote
{
}

- (void) runStopped:(NSNotification*)aNote
{
}

- (void) timeout
{
	NSLogError(@"CP8Cryopump",@"command timeout",nil);
	[cmdQueue removeAllObjects];
	[self setLastRequest:nil];
}

- (void) processOneCommandFromQueue
{
	
	if([cmdQueue count] == 0) return;
	ORCP8CryopumpCmd* cmdObj = [[[cmdQueue objectAtIndex:0] retain] autorelease];
	[cmdQueue removeObjectAtIndex:0];
	NSString* aCmd = cmdObj.cmd;
	if([aCmd isEqualToString:@"++ShipRecords"]){
		if(shipTemperatures) [self shipTemperatureValues];
		[self processOneCommandFromQueue];
	}
	else {
		if(cmdObj.waitForResponse) {
			[self performSelector:@selector(timeout) withObject:nil afterDelay:3];
			[self setLastRequest:aCmd];
		}
		else [self setLastRequest:nil];
		if(![aCmd hasSuffix:@"\r\n"]) aCmd = [aCmd stringByAppendingString:@"\r\n"];
		[serialPort writeString:aCmd];
		if(!lastRequest){
			[self processOneCommandFromQueue];
		}
	}
}

- (float) responseAsFloat:(NSString*)theResponse
{
	return [[theResponse substringWithRange:NSMakeRange(2,[theResponse length]-4)]floatValue];
}

- (int) responseAsInt:(NSString*)theResponse
{
	return [[theResponse substringWithRange:NSMakeRange(2,[theResponse length]-4)]intValue];
}

- (BOOL) responseAsBool:(NSString*)theResponse
{
	return [[theResponse substringWithRange:NSMakeRange(2,[theResponse length]-4)]intValue];
}

- (NSString*) responseAsString:(NSString*)theResponse
{
	return [theResponse substringWithRange:NSMakeRange(2,[theResponse length]-4)];
}

- (void) process_response:(NSString*)theResponse
{	
	if(!lastRequest)return;
	if([theResponse hasPrefix:@"$A"]){
		switch([[lastRequest substringWithRange:NSMakeRange(1,1)] intValue]){
			case 'X': [self setDutyCycle: [self responseAsInt:theResponse]];			 break;
			case 'Y': [self setElapsedTime: [self responseAsInt:theResponse]];			 break;
			case 'm': [self setFailedRateRiseCycles:[self responseAsInt:theResponse]];	 break;
			case 'I': [self setFailedRepurgeCycles: [self responseAsInt:theResponse]];	 break;
			case 'J': [self setFirstStageTemp:		[self responseAsFloat:theResponse]]; break;
			case 'H': 
				[self setFirstStageControlTemp:		[self responseAsInt:theResponse]%400];	
				[self setFirstStageControlMethod:	[self responseAsInt:theResponse]/400];	
			break;
			case 'n': [self setLastRateOfRaise:		[self responseAsInt:theResponse]];			break;
			case '@': [self setModuleVersion:		[self responseAsString:theResponse]];		break;
			case 't': [self setPowerFailureRecoveryStatus: [self responseAsInt:theResponse]];	break;
			case 'A': [self setPumpStatus:			[self responseAsBool:theResponse]];			break;
			case 'E': [self setPurgeStatus:			[self responseAsBool:theResponse]];			break;
			case 'e': 
			{
				switch([[theResponse substringWithRange:NSMakeRange(2,1)] intValue]){
					case '@':	[self setRegenerationError:0]; break;
					case 'B':	[self setRegenerationError:1]; break;
					case 'C':	[self setRegenerationError:2]; break;
					case 'D':	[self setRegenerationError:3]; break;
					case 'E':	[self setRegenerationError:4]; break;
					case 'F':	[self setRegenerationError:5]; break;
					case 'G':	[self setRegenerationError:6]; break;
					case 'H':	[self setRegenerationError:7]; break;
				}
			}
			break;
			case 'P': 
			{
				switch([[theResponse substringWithRange:NSMakeRange(2,1)]intValue]){
					case '0': [self setPumpRestartDelay:	[self responseAsInt:theResponse]];  break;
					case '1': [self setExtendedPurgeTime:	[self responseAsInt:theResponse]];  break;
					case '2': [self setRepurgeCycles:		[self responseAsInt:theResponse]];  break;
					case '3': [self setRoughToPressure:		[self responseAsInt:theResponse]];  break;
					case '4': [self setRateOfRise:			[self responseAsInt:theResponse]];  break;
					case '5': [self setRateOfRiseCycles:	[self responseAsInt:theResponse]];  break;
					case '6': [self setRestartTemperature:	[self responseAsBool:theResponse]]; break;
					case 'A': [self setRoughingInterlock:	[self responseAsInt:theResponse]];  break;
					case 'C': [self setPumpsPerCompressor:	[self responseAsInt:theResponse]];  break;
					case 'G': [self setRepurgeTime:			[self responseAsInt:theResponse]];  break;
					case 'z': [self setStandbyMode:			[self responseAsBool:theResponse]]; break;
				}
					
			}
			break;
				
			case 'O': [self setRegenerationSequence:	[self responseAsInt:theResponse]];			break;
			case 'j': [self setRegenerationStartDelay:	[self responseAsInt:theResponse]];			break;
			case 'k': [self setRegenerationStepTimer:	[self responseAsInt:theResponse]];			break;
			case 'a': [self setRegenerationTime:		[self responseAsInt:theResponse]];			break;
			case 'D': [self setRoughValveStatus:		[self responseAsBool:theResponse]];			break;
			case 'Q': [self setRoughingInterlock:		[self responseAsInt:theResponse] - 0x30];	break;
			case 'K': [self setSecondStageTemp:			[self responseAsFloat:theResponse]];		break;
			//case 'I': [self setSecondStageTempControl:	[self responseAsInt:theResponse]];			break;
			case 'S': [self setStatus:					[self responseAsInt:theResponse] - 0x20];	break;
			case 'B': [self setThermocoupleStatus:		[self responseAsBool:theResponse]];			break;
			case 'L': [self setThermocouplePressure:	[self responseAsFloat:theResponse]];		break;
		}
	}
}

- (NSString*) checkSum:(NSString*)aCmd
{
	//calculate the mod 256 of the character sum 
	int i;
	unsigned char charSum = 0;
	for(i=0 ; i<[aCmd length] ; i++) {
		charSum+=[aCmd characterAtIndex:i]; //add up each character value adding it to the total
	}
	
	//now that the characters are added XOR bits
	//get the bit values of the sum 
	BOOL D0 = charSum&0x01;	//and the sum with the zero bit 
	BOOL D1 = charSum&0x02;	//and the sum with the first bit 
	BOOL D6 = charSum&0x40;	//and the sum with the sixth bit 
	BOOL D7 = charSum&0x80;	//and the sum with the seventh bit 
						//calculate XORs to strip bits 6&7
	D1 = D1^D7;			//D1 XOR D7 
	D0 = D0^D6;			//D0 XOR D6 
						//strip out old bits D0-D1, D6-D7 
	charSum &= 0x3C;	//and the sum with 0x3C 
						//replace bits D0-D1 with the results 
	charSum |= D0;		//OR in the resultant zero bit 
	charSum |= D1*0x02;	//OR in the resultant one bit
						//now add the '0' character to the result 
	charSum += '0';		//so the final outcome is a character from '0' to '??' 
	
	return [NSString stringWithFormat:@"%c",charSum];
}

@end

@implementation ORCP8CryopumpCmd
@synthesize cmd,waitForResponse;
- (void) dealloc
{
	self.cmd		 = nil;
	[super dealloc];
}
@end
